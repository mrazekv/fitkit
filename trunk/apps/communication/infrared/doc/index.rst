.. article:: apps_demo_infra    :author: Michal Rùek <xruzek01 AT stud.fit.vutbr.cz>    :updated: 20100513    Èlánek popisuje komunikaèní protokoly pouívané v dálkovıch ovladaèích spotøební elektroniky. Pomocí jednoduchého    rozšiøujícího modulu lze pøes FITkit ovládat jiná zaøízení a dekódovat pøíchozí signál z ovladaèe.==========================================Pøijímaè/vysílaè dálkového ovládání==========================================Popis protokolù==================Jako svìtelné zdroje se v dálkovıch ovladaèích pouívají luminiscenèní diody infra-LED, emitující paprsekzáøení o vlnové délce kolem 950nm. Jeliko pøi posílání informace zpùsobem log.1 = "infra-LED svítí",log.0 = "nesvítí" by bylo obtíné zajistit bezchybnı pøenos datového rámce z dùvodu vysokého rušení(zdrojem takového infraèerveného záøení je i slunce èi obyèejná árovka), vyuívá se modulace.Pøi modulaci logickou úrovní 1 se infra-LED budí obdélníkovım nosnım signálem o dané støídì a frekvenci, typickymezi 30-56kHz. Tento stav se nazıvá *znaèka* (ang. *mark*). Po dobu logické úrovnì 0 není dioda aktivní,nastala *mezera* (ang. *space*). Dobu trvání znaèky a mezery, stejnì tak jako jejich vıznam specifikujepouitı protokol. V klidu, tj. kdy neprobíhá pøenos rámce, setrvává vysílaè ve stavu log.0. Pøijímaè signálu jenastaven na pouitı nosnı kmitoèet. Tím, e ostatní kmitoèty odfiltruje, úèinnì zamezuje monému rušení okolním svìtlem.Philips RC5--------------Mezi nejznámìjší protokoly patøí RC5, pùvodnì vyvinutı firmou Philips. Datovı rámec protokolu se skládá z celkem14 bitù, je jsou vyslány v tomto poøadí:- 2 start-bity (zahájení komunikace)- toggle bit (zabezpeèovací mechanismus)- 5 bitù pro adresaci zaøízení  (televizní pøijímaè, videorekordér, satelit ...)- 6 bitù vyhrazenıch pro pøíkaz (zmìna hlasitosti, pøepnutí kanálu, atp.)  Oba start-bity jsou vdy logické úrovnì 1 a kromì indikace zaèátku datového rámce podle nich pøijímaè automatickydolaïuje zisk a citlivost na pøíchozí infraèervenı signál (ang. AGC = Automatic Gain Control).Hodnota toggle (èes. pøeklápìcího) bitu se pøi kadém novém stisku klávesy mìní na opaènou. Díky nìmu lze na pøijímacístranì rozlišit mezi trvale stisknutım tlaèítkem a jednotlivımi stisky po sobì. Pokud je napøíklad trvale drena èíslice1 na dálkovém ovladaèi televizního pøijímaèe, nedojde ani po vloení a následném odstranìní pøekáky v cestì IR paprskuk pøepnutí na jedenáctı kanál.Následují bity reprezentující adresu zaøízení a kód pøíkazu, pøièem v obou pøípadech se nejvıznamnìjší bit(MSB) vysílá jako první... figure:: rc5-manchester.png   :alt: RC kódování manchester   Manchester kódování, pøevzato z [1]_Protokol RC5 pracuje na nosné frekvenci 36kHz a pro odesílání dat se pouívá kódování Manchester. Toto kódování, nìkdyté zvané jako bifázová modulace, spojuje datovı signál se synchronizaèním. Bitovı interval je rozdìlen na dvì stejnìvelké èásti a doprostøed intervalu je vloena zmìna signálu. Hodnota bitu je pak dána smìrem hrany signálové zmìny.Pro RC5 je bit o log.0  definován zmìnou ze znaèky na mezeru, opaènì pak pro logickou 1, viz obrázek vıše.Bitovı interval má konstantní délku rovnou 64 periodám nosného kmitoètu, tedy 64 / 36kHz = 1778us. Odtud platí, e odeslání všech 14-ti bitovıch intervalù potrvá 14 x 1778us = 25ms. Doba znaèky èi mezery je sloenaz 32 period nosné, tj. 889us... figure:: rc5-ramec.png   :alt: rámec RC5 protokolu   Rámec protokolu RC5, pøevzato z [1]_Rámec bude opakovanì vysílán, dokud bude dreno tlaèítko na dálkovém ovladaèi. Perioda opakování, poèítáme-li jí jakoèas mezi zaèátky obou rámcù, odpovídá dobì odeslání 64 bitù, èili 113,7ms. Pro pøipomenutí, hodnota toggle bitu se vprùbìhu opakovaného vysílaní tého rámce nemìní.**RC5X**Šestibitová hodnota pøíkazu v protokolu RC5 se èasem ukázala jako nedostaèující, co vedlo k pøidání dalšího bitua zvıšení poètu monıch pøíkazù na 128. Pøidanı sedmı bit nahrazuje druhı start-bit, navíc je jeho hodnota invertována.Inverze zaruèuje zpìtnou kompatibilitu s pùvodním protokolem RC5: pro pøíkazy 0-63 bude negovanı sedmı bit rovenlogické 1 a zaøízení vybavené starším standardem RC5 jej proto bude chápat jako obyèejnı start-bit. Rozšíøenému protokoluse dostalo názvu RC5X, z anglického Extended RC5.NEC------Tento protokol, vytvoøenı spoleèností NEC Electronics, je pouíván ve spotøební elektronice vìtšiny japonskıch vırobcù,napøíklad Pioneer, Onkyo, Hitachi, NEC, Teac, èi Yamaha. Mezi jeho pøednosti patøí monost kontroly dat proti chybáma také adresování a cca 65000 zaøízení v rozšíøeném  módu... figure:: nec-modulace.png   :alt: NEC modulace   NEC - pulznì pozièní modulaceProtokol operuje na nosné frekvenci 38kHz a pro kódování bitù se pouívá pulznì pozièní modulace. Pulzy jsou pøi tétomodulaci vdy stejnì dlouhé, a to 560us. Hodnota bitu je potom definována dobou mezi zaèátky tìchto dvou pulzù.Pro logickou hodnotu 1 èiní tato doba 2,25ms, pro logickou 0 pøesnì polovinu, tedy 1,125ms.Datovı rámec protokolu NEC lze rozdìlit na 3 hlavní èásti:- hlavièka, ang. leader code,- èást pro adresu zaøízení nebo kód vırobce, zvaná té custom code,- datová èást obsahující ovládací pøíkaz.Hlavièka protokolu vdy zaèíná 9ms znaèkou následovanou mezerou. Délka mezery rozlišuje typ rámce. Novìjšíspecifikace protokolu toti umoòuje vyslání jednoho celého rámce a poté, v pøípadì, e je tlaèítko stále stisklé,se vysílá pouze krátká informace o opakování pøedchozího rámce. Tato vlastnost, v anglické dokumentaci oznaèovanájako one-shot transmission mode, sniuje spotøebu energie a o jednu tøetinu. Takté se s její pomocí dá rozpoznattrvalı stisk tlaèítka a opakovanı stisk. Bude-li tedy doba vıše zmínìné mezery rovna 2,25ms, jedná se o opakovací kóda kromì 560us znaèky ukonèující tuto mezeru se další data nevyšlou. Doba 4,5ms naopak signalizuje, e hlavièka budenásledována zbıvajícími 32 bity rámce. Doba k opìtovnému vyslání rámce, pøíp. opakovacího kódu èiní 108ms... figure:: nec-opakovani.png   :alt: NEC opakovací sekvence   Jeden datovı rámec NEC a opakovací sekvence, pøevzato z [3]_    Blok adresy se skládá z 16 bitù, kódovanıch podle uvedené modulace. Jako první se odesílá nejménì platnı bit (LSB).V pùvodní verzi protokolu obsahoval niší byte adresu cílového zaøízení, ve vyšším byla uloena její invertovaná podobavyuitá pøi kontrole pøi pøíjmu. Novìjší specifikace dovoluje adresu rozšíøit na celıch 16 bitù. Pøipravíme se taksice o monost kontroly správnosti, vıraznì ale vzroste poèet monıch adres... figure:: nec-ramec.png   :alt: rámec protokolu NEC   Datovı rámec protokolu NEC, pøevzato z [2]_Podobnì jako pøedchozí èást, i èást pro pøíkaz obsahuje 16 bitù a jako první se vysílá nejménì platnı bit. Zde ovšemzùstala zachována redundance v podobì negované informace v horním bytu. Poèet pøíkazù tedy dosahuje maximálnì 256monıch variant. Horní negovanı byte bude vyuit po pøijetí rámce k ovìøení validity dat.Sony SIRC------------Mezi poslední pøedstavitele rozšíøenìjších komunikaèních protokolù patøí SIRC (Serial Infra-Red Control) od japonskéfirmy Sony. Pøenášená data jsou kódována pulznì šíøkovou modulací a následnì vysílána na nosnéfrekvenci 40kHz. Hodnota bitù se pøi této modulaci rozlišuje délkou trvání znaèky. Znaèka o délce 1,2ms pøedstavujelogickou jednièku. Logická nula trvá polovièní dobu, 600us. Znaèky od sebe oddìluje mezera s konstantní dobou 600us. .. figure:: sirc-ramec.png   :alt: rámec protokolu SIRC   12-ti bitovı rámec protokolu SIRC, pøevzato z [4]_Zaèátek rámce tvoøí úvodní 2,4ms trvající znaèka, po ní následuje 600us mezera a pak ji vlastní data, pøièemjednotlivé èásti jsou vysílány od nejménì vıznamného bitu. Postupnım vıvojem vznikly 3 varianty tohoto protokolu,lišící se však pouze poètem bitù:- 12-ti bitová verze odesílá 7-mi bitovı pøíkaz, poté 5-ti bitovou adresu zaøízení,- 15-ti bitová varianta pouze rozšiøuje adresu na 8 bitù,- 20-ti bitovı protokol vychází z 12-ti bitového, za adresovou èást navíc pøipojuje osmibitová rozšíøující (ang. extended) data. Rámec je periodicky vysílán, dokud je dreno tlaèítko na ovladaèi. Doba, za kterou dojde k opakovanému vyslání,se rovná 45ms od zaèátku rámce.Rozšiøující modul====================HW pøípravek obsahující pøijímací a vysílací èást je pøipojen ke konektoru JP10, na FITkitu se nachází úplnì dole.Situaci ponìkud komplikuje fakt, e prvních 6 vıvodù X0-X5 je pouito k interním úèelùm, napøíklad X0 fungujejako vıstup z øadièe pøerušení. Prvním pinem, kterı lze vyuít pro vlastní úèely, pin X6. Kolíky èíslo 11 a 12 nejsouu FITkitu verze 2.0 zapojeny, díky tomu se pin X6 posouvá a na kolík 13, na kterém je ve verzi 1.2 pøipojen bod X8.Pøi pouití jiné verze FITkitu je proto dùleité správnì upravit názvy pinù v kódu `file:top_level.vhd`. .. figure:: konektor.png   :alt: konektor na FITkitu   Konektor JP10 a popis dùleitıch pinùZ obrázku je patrné, e napìtí +5V vèetnì nulového bodu GND, potøebné pro napájení pøijímaèe TSOP a vysílací infra-LED senachází ve spodní øadì za sebou. Pro pøipojení pøípravku tedy vystaèíme s jednoøadou dutinkovou lištou, zaèínající nalevé stranì spodní poloviny konektoru. Vyuijeme lištu o délce deseti dutinek, která se bìnì vyrábí.Schéma zapojení------------------K pøíjmu signálu všech tøí frekvencí (36kHz, 38kHz, 40kHz) postaèí integrovanı pøijímaè s nosnım kmitoètem 40kHz,tedy TSOP1740. Pomalejší kmitoèty toti dle katalogového listu splòují pravidlo minimální délky trvání pulzu(10 period nosné) a proto budou pøijímaèem bezchybnì dekódovány... figure:: schema.png   :alt: schéma zapojení pøípravku   Schéma zapojení pøípravkuKondenzátor C1 a rezistor R3 spoleènì tvoøí filtr, kterı potlaèuje rušení vzniklé v rozvodu napájecího napìtí a kteréby jinak nepøíznivì ovlivnilo spolehlivou èinnost pøijímaèe. Vysílací èást tvoøí tranzistor T1 v zapojeníse spoleènım emitorem, v jeho kolektorovém obvodu je pøipojená infraèervená LED1 s vlnovou délkou 950nm.Rezistor R1 omezuje proud tekoucí infra-LED a pomocí nìho lze mìnit vyzáøenı svìtelnı vıkon diody. Pro správnou funkcipøípravku je nutné u starší verze FITkitu propojit vıstup z pøerušení FPGA s mikrokontrolérem. Pøerušení je vyvedeno napin X0 a protoe pouitá dutinková lišta SV1 tento pin zakrıvá, je nutné jej vyvést na desku HW pøípravku (JP1) anáslednì tento novı kolík propojit drátem s vıvodem 26 na konektoru JP9. Pøi pouití nového FITkitu verze 2.0 slouík tomuto spojení propojka J5, zmínìnı drát není nutné pøipojovat.  .. figure:: deska.png   :alt: deska plošnıch spojù      DPS - pohled ze strany spojù a osazení   .. figure:: foto-pripravek.png   :alt: hotovy prirpavek      Hotovı pøípravek pøipojenı k FITkitu   Seznam souèástek---------------------=====  =====JP1    pin S1G01SV1    dutinková lišta BLW810GR1     22RR2     4k7R3     100RC1     4,7uF/16VLED1   LD274-3T1     BC337-40IR1    TSOP1740=====  =====Komunikaèní knihovna========================Pro korektní funkci knihovny ``infra_comm`` je nutné mít správnì nastavenu bázovou adresu SPI øadièe a pøiøazeny offsety k pouitım transceiverùm.Vıchozí hodnota bázové adresy ``INFRA_BASE_ADDR`` se rovná 90h. Knihovna pøedpokládá pouití pouze jednoho SPI dekodérupro všechny transceivery. Konkrétní transceiver se vybírá prostøednictvím nejniších bitù adresy, která se získá souètem patøiènéhooffsetu s bázovou adresou. Pokud napøíklad poaduji aplikaci pouze s transceiverem protokolu RC5X,nastavím konstantu ``IR_RC5_OFFSET`` na hodnotu 0, transceiver tak bude pøístupnı pøímo pøes bázovou adresu.K rùznım aplikacím se mùe hodit rùzná velikost pøijímací èi vysílací fronty, jejich implicitní pìtimístnou velikost lze upravit zmìnou konstant``IR_RX_BUF_LEN`` a ``IR_RX_BUF_LEN``.Poèáteèní inicializaci knihovny zajišuje procedura ``infra_init()``, která uvede interní promìnné do vıchozího stavu.Test na prázdnost nìkteré z front realizují funkce ``infra_rx_empty()`` a ``infra_tx_empty()``. V nìkterıch situacíchse mùe hodit i kontrola, zda jsou vysílací èásti transceiverù v klidovém stavu, k tomuto úèelu slouí funkce ``infra_no_tx_transmit()``.Následující rutiny se pouívají k vlastnímu pøenosu dat. Procedura ``infra_rx_interrupt_handler(unsigned char proto_type)`` pøeètev obsluze pøerušení data z FPGA a uloí je do pøijímacího bufferu. Parametr ``proto_type`` pøitom urèuje typ protokolu, a mùe nabıvat tìchto hodnot:- ``IR_RC5``,- ``IR_NEC_NORM``,- ``IR_SIRC_12B``,- ``IR_SIRC_15B``,- ``IR_SIRC_20B``.Pomocí typu se urèuje offset, kterı bude pøipoèten k bázové adrese. Ke ètení poloky z bufferu slouí funkce``infra_read(unsigned char *proto, unsigned char *data)``. Parametry jsou pøedávány odkazem, do prvního funkce uloí typ protokolu a dodruhého se nahrají data z bufferu. Druhı parametr musí bıt typu pole o délce 3 byty. Data jsou v poli zarovnána zpùsobem, kde je spodní bytez FPGA uloen do prvku s indexem 2, zatímco horní byte do prvku s nejniším indexem, tj. 0. Po provedení této rutiny se pøeètená polokaz bufferu automaticky odstraní. Návratová hodnota funkce je pøi úspìšném ètení rovna jedné, jinak nula.Funkce ``infra_send(unsigned char proto, unsigned char *data)`` slouí k zápisu dat do bufferu a k jejich odvysílání. Její parametry seprakticky shodují s vıše uvedenımi, pouze k typu protokolu pøibyla monost ``IR_NEC_REPEAT``, pøi jejím zvolení se místoklasického rámce NEC posílá rámec opakovací.Ke správné èinnosti algoritmu je zapotøebí do obsluhy pøerušení pøidat také volání funkce ``infra_tx_interrupt_handler()``,které bude vykonáno po obdrení pøerušení informující mikrokontrolér o navrácení vysílaèù do klidového stavu. Díky tétofunkci následnì dojde k automatickému odvysílání další poloky z fronty.Popis aplikace=================Jako primární zpùsob ovládání aplikace jsem zvolil komunikaci pøes terminálové okno. Po spojení s poèítaèem je moné z nìj vyslat libovolnı kód,pøípadnì nastavit i poèet opakování. Po pøíjmu sekvence z dálkového ovladaèe a po jejím dekódování se vısledek automaticky odešle na obrazovkuterminálu. Seznam pøíkazù vèetnì syntaxe lze zobrazit pøíkazem ``HELP``. Pro ilustraci uvádím odeslání dvou totonıch rámcù protokolu RC5X:::  REPEAT 2  RC5 00 0C První pøíkaz nastaví (globálnì) poèet opakování rámce, zatímco druhı ji nese vlastní data. Pøi opakovaném zadávání pøíkazù RC5X se toggle bit mìníautomaticky v aplikaci, není proto nutné jej uvádìt. Hodnoty v hexadecimálním tvaru znaèí v uvedeném pøípadì adresu/zaøízení 00h (televizní pøijímaè),a hodnota 0Ch pøíkaz k pøechodu televize do pohotovostního reimu. U protokolu NEC dochází pøi nastavení opakování na hodnotu vìtší ne 1 k odeslánípouze jednoho datového rámce, zbytek vysílání bude tvoøen opakovací sekvencí. Obrázek níe zachycuje obsah terminálového okna po pøíjmudvou rámcù a po odeslání jedné datové sekvence protokolu SIRC... figure:: termscr.png   :alt: Snímek obrazovky terminálu   Snímek obrazovky termináluJinou monost odeslání kódu nabízí pouití klávesnice a LCD displeje. Sekvence urèená k odeslání je v tomto pøípadì uloena ve zdrojovém kódu aplikacea pro její zmìnu je nutné aplikaci znovu pøeloit a nahrát do FITkitu. Není to pøíliš flexibilní zpùsob, pouití nalezne spíše jako náhradadálkového ovladaèe, poté co jsme poadované kódy odladili pøes terminál. Tlaèítkem ``#`` lze pøepínat mezi rùznımi protokoly, pøièem ke kadémuz nich mùe bıt pøiøazena rozdílná sada kódù. LCD displej informuje uivatele o aktuálnì zvolené sadì (protokolu). Pøepínání toggle bitu protokoluRC5X, stejnì jako vysílání opakovacího rámce NEC, probíhá automaticky a není vyvedeno na ádnou klávesu.  Zprovoznìní aplikace========================  Ukázkovı program se nachází v seznamu projektù ve skupinì "Demo aplikace" podnázvem "InfraRed komunikace". Dvojitım poklepáním na oznaèenou poloku se automatickyspustí pøeklad projektu a následnì se nahraje do pøipojeného FITkitu. Aplikace ke svéèinnosti vyaduje propojit vıstup pøerušení z FPGA JP10(5) se vstupemmikrokontroléru JP9(26). V pøípadì FITkitu verze 2.x k tomuto úèelu slouí propojka J5... figure:: qdevkitscr.png   :alt: QDevKit screenshot      QDevKit - Umístìní aplikace v seznamu projektù ----------.. [1] SB-Projects: IR remote control: Philips RC-5; http://www.sbprojects.com/knowledge/ir/rc5.htm.. [2] SB-Projects: IR remote control: NEC protocol; http://www.sbprojects.com/knowledge/ir/nec.htm.. [3] MOS INTEGRATED CIRCUIT uPD6121, 6122; http://www.datasheetcatalog.org/datasheet/nec/UPD6122G-002.pdf  .. [4] SB-Projects: IR remote control: SIRC protocol; http://www.sbprojects.com/knowledge/ir/sirc.htm